kind: pipeline
name: default

workspace:
  base: /go
  path: src/github.com/costinm/istio-consul



steps:
  - name: test_docker
    image: docker:dind
    volumes:
      - name: dockersock
        path: /var/run
    commands:
      - sleep 5 # give docker enough time to start
      - docker ps -a

  - name: build
    image: golang
    commands:
      - go build cmd/istio-consul/istio-consul.go
      - go test ./pkg/...


services:
  - name: docker
    image: docker:dind
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run
  - name: nats
    image: nats:1.3.0
    ports:
      - 4222
      - 8222
  - name: discovery
    image: consul:latest
    command:
      - "agent"
      - "-dev"
    ports:
      - 8400
      - 8500
      - 8600

volumes:
  - name: dockersock
    temp: {}

